<!doctype html>
<html lang="ja">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>NDLOCR-Lite OCR Console</title>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=M+PLUS+1p:wght@400;500;700&display=swap"
			rel="stylesheet"
		/>
		<style>
			:root {
				--bg: #f3faf7;
				--panel: rgba(255, 255, 255, 0.9);
				--panel-inner: #ffffff;
				--ink: #1f2937;
				--muted: #556070;
				--line: #d0dce8;
				--accent: #0f766e;
				--accent-hover: #0d6460;
				--accent-light: #ccfbf1;
				--warn: #b45309;
				--danger: #dc2626;
				--success: #059669;
				--mono: "JetBrains Mono", ui-monospace, monospace;
				--sans: "M PLUS 1p", "Hiragino Kaku Gothic ProN", sans-serif;
				--shadow: 0 2px 12px rgba(15, 23, 42, 0.08);
				--radius: 12px;
				--tab-h: 38px;
			}

			[data-theme="dark"] {
				--bg: #0f172a;
				--panel: #1e293b;
				--panel-inner: #0f172a;
				--ink: #f1f5f9;
				--muted: #94a3b8;
				--line: #334155;
				--accent: #2dd4bf;
				--accent-hover: #5eead4;
				--accent-light: rgba(45, 212, 191, 0.15);
				--warn: #fbbf24;
				--danger: #f87171;
				--success: #34d399;
				--shadow: 0 2px 12px rgba(0, 0, 0, 0.4);
			}

			* { box-sizing: border-box; margin: 0; padding: 0; }

			html, body {
				height: 100%;
				font-family: var(--sans);
				color: var(--ink);
				background: var(--bg);
				transition: background .2s, color .2s;
			}

			.wrap {
				max-width: 1200px;
				margin: 0 auto;
				padding: 16px 14px 40px;
				display: grid;
				gap: 12px;
			}

			.panel {
				background: var(--panel);
				border: 1px solid var(--line);
				border-radius: var(--radius);
				box-shadow: var(--shadow);
			}

			/* â”€â”€ Header â”€â”€ */
			.header {
				padding: 14px 18px;
				display: flex;
				flex-wrap: wrap;
				gap: 10px;
				align-items: center;
				justify-content: space-between;
			}

			h1 { font-size: 18px; letter-spacing: .02em; }

			.header-right {
				display: flex;
				gap: 8px;
				flex-wrap: wrap;
				align-items: center;
			}

			.tag {
				display: inline-flex;
				align-items: center;
				gap: 6px;
				font-size: 11px;
				font-family: var(--mono);
				border: 1px solid var(--line);
				border-radius: 999px;
				padding: 5px 10px;
				background: var(--panel-inner);
				color: var(--muted);
			}

			.tag-dot {
				width: 7px; height: 7px;
				border-radius: 50%;
				display: inline-block;
				background: var(--muted);
			}
			.tag-dot.green { background: var(--success); }
			.tag-dot.red   { background: var(--danger); }

			.btn-icon {
				width: 32px; height: 32px;
				display: grid; place-items: center;
				border: 1px solid var(--line);
				border-radius: 8px;
				background: var(--panel-inner);
				cursor: pointer;
				color: var(--muted);
				font-size: 16px;
				line-height: 1;
				flex-shrink: 0;
				padding: 0;
				box-sizing: border-box;
			}
			.btn-icon:hover { color: var(--ink); border-color: var(--accent); }
			#themeToggle { font-style: normal; color: initial; }

			/* â”€â”€ Form â”€â”€ */
			form {
				padding: 14px 18px 18px;
				display: grid;
				gap: 12px;
			}

			fieldset {
				border: 1px solid var(--line);
				border-radius: 10px;
				padding: 10px 12px 12px;
				background: var(--panel-inner);
			}

			legend {
				padding: 0 6px;
				font-size: 11px;
				font-weight: 700;
				color: var(--muted);
				letter-spacing: .05em;
			}

			.group-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 10px;
				margin-top: 10px;
			}

			label {
				display: grid;
				gap: 5px;
				font-size: 12px;
				color: var(--muted);
			}

			input, select {
				font: inherit;
				width: 100%;
				border: 1px solid var(--line);
				border-radius: 8px;
				padding: 8px 10px;
				background: var(--panel-inner);
				color: var(--ink);
				font-size: 13px;
			}
			input:focus, select:focus { outline: 2px solid var(--accent); outline-offset: 1px; }

			.file-dropzone {
				position: relative;
				min-height: 80px;
				border: 2px dashed var(--line);
				border-radius: 10px;
				background: var(--bg);
				display: grid;
				place-items: center;
				text-align: center;
				padding: 10px;
				transition: border-color .15s, background .15s;
				cursor: pointer;
			}
			.file-dropzone.is-dragging {
				border-color: var(--accent);
				background: var(--accent-light);
			}
			.file-drop-text { font-size: 12px; color: var(--muted); pointer-events: none; }
			.file-drop-text strong { display: block; color: var(--ink); font-size: 13px; margin-bottom: 3px; }
			.file-input-overlay {
				position: absolute; inset: 0; opacity: 0; cursor: pointer;
				width: 100%; height: 100%;
			}


			.actions {
				display: flex; align-items: center; gap: 10px; grid-column: 1 / -1;
			}

			button {
				font: inherit; border: 0; border-radius: 8px; padding: 9px 18px;
				cursor: pointer; font-weight: 600; font-size: 13px;
			}
			.btn-primary { background: var(--accent); color: #fff; }
			.btn-primary:hover { background: var(--accent-hover); }
			.btn-primary:disabled { opacity: .55; cursor: not-allowed; }
			.btn-cancel { background: var(--warn); color: #fff; }
			.btn-cancel:disabled { opacity: .55; cursor: not-allowed; }
			.btn-outline {
				background: var(--panel-inner); border: 1px solid var(--line); color: var(--muted);
			}
			.btn-outline:hover { border-color: var(--accent); color: var(--ink); }
			.btn-outline.copied { background: var(--accent); border-color: var(--accent); color: #fff; }

			.note { font-size: 12px; color: var(--muted); }
			.hidden { display: none !important; }

			/* â”€â”€ Result panel â”€â”€ */
			.result-header {
				padding: 12px 18px;
				border-bottom: 1px solid var(--line);
				display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
			}
			.result-header .btn-outline { margin-left: auto; }

			.page-picker {
				padding: 10px 18px 0;
				display: flex; align-items: center; gap: 10px;
			}
			.page-picker label { min-width: fit-content; }
			.page-picker select { max-width: 220px; }

			.summary-row {
				padding: 8px 18px 0;
				display: flex; flex-wrap: wrap; gap: 6px;
			}
			.badge {
				font-size: 11px; font-family: var(--mono);
				border-radius: 999px; padding: 3px 9px;
				background: var(--accent-light); color: var(--accent);
				border: 1px solid var(--accent);
			}

			/* â”€â”€ Tabs â”€â”€ */
			.tabs {
				display: flex; gap: 2px;
				padding: 10px 18px 0;
				border-bottom: 1px solid var(--line);
			}
			.tab-btn {
				height: var(--tab-h); padding: 0 14px;
				background: transparent; border: 0; border-bottom: 2px solid transparent;
				color: var(--muted); font-size: 12px; font-weight: 600;
				cursor: pointer; border-radius: 0;
				transition: color .1s, border-color .1s;
			}
			.tab-btn:hover { color: var(--ink); }
			.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

			.tab-panel { display: none; padding: 14px 18px 18px; }
			.tab-panel.active { display: block; }

			/* text tab */
			pre.ocr-text {
				font-family: var(--mono); font-size: 12px; line-height: 1.7;
				white-space: pre-wrap; word-break: break-word;
				background: var(--panel-inner); border: 1px solid var(--line);
				border-radius: 8px; padding: 12px;
				max-height: 600px; overflow-y: auto;
			}

			/* html tab */
			.html-preview-wrap { display: flex; flex-direction: column; gap: 8px; }
			.html-preview-actions { display: flex; gap: 8px; align-items: center; }
			iframe.html-frame {
				width: 100%; height: 500px;
				border: 1px solid var(--line); border-radius: 8px; background: #fff;
			}

			/* layout tab */
			.layout-preview-wrap { text-align: center; }
			.layout-img {
				max-width: 100%; height: auto;
				border: 1px solid var(--line); border-radius: 8px; cursor: zoom-in;
			}

			/* â”€â”€ Lightbox â”€â”€ */
			#lightbox {
				position: fixed; inset: 0;
				background: rgba(0,0,0,.8); z-index: 999;
				display: flex; align-items: center; justify-content: center; padding: 20px;
			}
			#lightbox-close {
				position: fixed; top: 14px; right: 18px;
				width: 36px; height: 36px; border-radius: 50%;
				background: rgba(255,255,255,.15); border: 1px solid rgba(255,255,255,.3);
				color: #fff; font-size: 20px; cursor: pointer;
				display: grid; place-items: center; line-height: 1;
			}
			#lightbox-content { max-width: 96vw; max-height: 92vh; overflow: auto; }
			#lightbox-content img { max-width: 100%; max-height: 88vh; border-radius: 4px; }
			#lightbox-content iframe {
				width: 90vw; height: 88vh; border: none; border-radius: 4px; background: #fff;
			}

			@media (max-width: 640px) { .group-grid { grid-template-columns: 1fr; } }
		</style>
	</head>
	<body>
		<div class="wrap">
			<!-- â”€â”€ Header â”€â”€ -->
			<section class="panel">
				<div class="header">
					<h1>NDLOCR-Lite OCR Console</h1>
					<div class="header-right">
						<span class="tag" id="statusModel">model: -</span>
						<span class="tag" id="statusDevice">device: -</span>
						<button class="btn-icon" id="themeToggle" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿" aria-label="toggle dark mode">ğŸŒ™</button>
					</div>
				</div>

				<!-- â”€â”€ Upload Form â”€â”€ -->
				<form id="analyzeForm">
					<fieldset>
						<legend>å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«</legend>
						<div class="group-grid">
							<label style="grid-column: 1 / -1;">
								<span>ç”»åƒ / PDF</span>
								<div class="file-dropzone" id="fileDropzone">
									<div class="file-drop-text" id="fileDropText">
										<strong>ãƒ‰ãƒ©ãƒƒã‚° &amp; ãƒ‰ãƒ­ãƒƒãƒ—</strong>
										ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
									</div>
									<input id="file" name="file" type="file"
										class="file-input-overlay" accept=".pdf,image/*" required />
								</div>
							</label>
						</div>
					</fieldset>

					<fieldset>
						<legend>è¨­å®š</legend>
						<div class="group-grid">
							<label>
								<span>æ”¹è¡Œå‡¦ç†</span>
								<select id="linebreak_mode" name="linebreak_mode">
									<option value="none" selected>å‡¦ç†ã—ãªã„ï¼ˆè¡Œã”ã¨ã«æ”¹è¡Œï¼‰</option>
									<option value="paragraph">ç¨®åˆ¥åˆ¥æ•´å½¢ï¼ˆè¦‹å‡ºã—ãƒ»æœ¬æ–‡ãƒ»æ³¨ã‚’åˆ†é›¢ï¼‰</option>
									<option value="compact">å…¨çµåˆï¼ˆæ”¹è¡Œã‚’ã™ã¹ã¦é™¤å»ï¼‰</option>
								</select>
							</label>
							<label>
								<span>DPIï¼ˆPDF ã®ã¿ï¼‰</span>
								<input id="dpi" name="dpi" type="number" min="72" max="600" value="220" />
							</label>
						</div>
					</fieldset>

					<div class="actions">
						<button id="submitBtn" class="btn-primary" type="submit">å®Ÿè¡Œ</button>
						<button id="cancelBtn" class="btn-cancel hidden" type="button" disabled>ä¸­æ–­</button>
						<span class="note" id="requestNote">å¾…æ©Ÿä¸­</span>
					</div>
				</form>
			</section>

			<!-- â”€â”€ Results â”€â”€ -->
			<section class="panel hidden" id="resultPanel">
				<div class="result-header">
					<span class="tag" id="tagLinebreak">linebreak: -</span>
					<span class="tag" id="tagPages">pages: -</span>
					<span class="tag" id="tagDevice">device: -</span>
					<button id="copyBtn" class="btn-outline" type="button" disabled>ã‚³ãƒ”ãƒ¼</button>
				</div>

				<div class="page-picker hidden" id="pagePickerWrap">
					<label for="pageSelect" style="font-size:12px;color:var(--muted);">ãƒšãƒ¼ã‚¸</label>
					<select id="pageSelect"></select>
				</div>

				<div class="summary-row" id="summaryRow"></div>

				<!-- tabs -->
				<div class="tabs">
					<button class="tab-btn active" data-tab="text">ãƒ†ã‚­ã‚¹ãƒˆ</button>
					<button class="tab-btn" data-tab="html">HTML</button>
					<button class="tab-btn" data-tab="layout">ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</button>
				</div>

				<!-- ãƒ†ã‚­ã‚¹ãƒˆ tab -->
				<div class="tab-panel active" id="panel-text">
					<pre class="ocr-text" id="textContent">ã“ã“ã«èªè­˜çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</pre>
				</div>

				<!-- HTML tab -->
				<div class="tab-panel" id="panel-html">
					<div class="html-preview-wrap">
						<div class="html-preview-actions">
							<span class="note">ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸ OCR çµæœ</span>
							<button class="btn-outline" id="htmlExpandBtn" type="button">å…¨ç”»é¢</button>
							<button class="btn-outline" id="htmlCopyBtn" type="button">HTML ã‚³ãƒ”ãƒ¼</button>
						</div>
						<iframe class="html-frame" id="htmlFrame" sandbox="allow-same-origin"></iframe>
					</div>
				</div>

				<!-- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ tab -->
				<div class="tab-panel" id="panel-layout">
					<div class="layout-preview-wrap">
						<img class="layout-img hidden" id="layoutImg" alt="layout preview" />
						<p class="note hidden" id="layoutNone">ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
					</div>
				</div>
			</section>
		</div>

		<!-- Lightbox -->
		<div id="lightbox" class="hidden" role="dialog" aria-modal="true">
			<button id="lightbox-close" aria-label="é–‰ã˜ã‚‹">âœ•</button>
			<div id="lightbox-content"></div>
		</div>

		<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// State
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentResults   = [];
let currentPageIndex = 0;
let activeRequestId  = null;
let progressTimer    = null;
let copyTimer        = null;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DOM refs
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const form           = document.getElementById("analyzeForm");
const submitBtn      = document.getElementById("submitBtn");
const cancelBtn      = document.getElementById("cancelBtn");
const copyBtn        = document.getElementById("copyBtn");
const requestNote    = document.getElementById("requestNote");
const fileInput      = document.getElementById("file");
const fileDropzone   = document.getElementById("fileDropzone");
const fileDropText   = document.getElementById("fileDropText");
const pagePickerWrap = document.getElementById("pagePickerWrap");
const pageSelect     = document.getElementById("pageSelect");
const resultPanel    = document.getElementById("resultPanel");
const summaryRow     = document.getElementById("summaryRow");
const textContent    = document.getElementById("textContent");
const htmlFrame      = document.getElementById("htmlFrame");
const layoutImg      = document.getElementById("layoutImg");
const layoutNone     = document.getElementById("layoutNone");
const lightbox       = document.getElementById("lightbox");
const lightboxClose  = document.getElementById("lightbox-close");
const lightboxContent= document.getElementById("lightbox-content");

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Dark mode
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const themeToggle = document.getElementById("themeToggle");

function applyTheme(dark) {
	document.documentElement.setAttribute("data-theme", dark ? "dark" : "");
	themeToggle.textContent = dark ? "â˜€ï¸" : "ğŸŒ™";
}

(function initTheme() {
	const stored = localStorage.getItem("ndlocr_theme");
	const dark = stored ? stored === "dark" : window.matchMedia("(prefers-color-scheme: dark)").matches;
	applyTheme(dark);
})();

themeToggle.addEventListener("click", () => {
	const dark = document.documentElement.getAttribute("data-theme") !== "dark";
	applyTheme(dark);
	localStorage.setItem("ndlocr_theme", dark ? "dark" : "light");
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// File dropzone
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDropText() {
	if (fileInput.files && fileInput.files.length > 0) {
		fileDropText.innerHTML = `<strong>é¸æŠä¸­:</strong> ${fileInput.files[0].name}`;
	} else {
		fileDropText.innerHTML = "<strong>ãƒ‰ãƒ©ãƒƒã‚° &amp; ãƒ‰ãƒ­ãƒƒãƒ—</strong> ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ";
	}
}

fileDropzone.addEventListener("dragenter", e => { e.preventDefault(); fileDropzone.classList.add("is-dragging"); });
fileDropzone.addEventListener("dragleave", e => { e.preventDefault(); if (!fileDropzone.contains(e.relatedTarget)) fileDropzone.classList.remove("is-dragging"); });
fileDropzone.addEventListener("dragover",  e => { e.preventDefault(); fileDropzone.classList.add("is-dragging"); });
fileDropzone.addEventListener("drop", e => {
	e.preventDefault();
	fileDropzone.classList.remove("is-dragging");
	const files = e.dataTransfer && e.dataTransfer.files;
	if (!files || !files.length) return;
	try { const dt = new DataTransfer(); for (const f of files) dt.items.add(f); fileInput.files = dt.files; } catch(_) {}
	updateDropText();
});
fileInput.addEventListener("change", updateDropText);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Status
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchStatus() {
	try {
		const r = await fetch("/api/status");
		const p = await r.json();
		document.getElementById("statusModel").textContent  = `model: ${p.model || "-"}`;
		document.getElementById("statusDevice").textContent = `device: ${p.device_default || "-"}`;
	} catch(_) {}
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Progress polling
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function stopPolling() {
	if (progressTimer) { clearInterval(progressTimer); progressTimer = null; }
}

function startPolling(rid) {
	stopPolling();
	const lbEl = document.getElementById("linebreak_mode");
	const lbLabel = lbEl.options[lbEl.selectedIndex].text;
	const poll = async () => {
		try {
			const r = await fetch(`/api/jobs/${encodeURIComponent(rid)}`);
			if (!r.ok) return;
			const p = await r.json();
			setBusy(true, p.message || "è§£æä¸­...");
			if (p.total_pages) document.getElementById("tagPages").textContent = `pages: ${p.total_pages}`;

			if (p.state === "done" || p.state === "canceled") {
				stopPolling();
				activeRequestId = null;
				renderResults(p, lbLabel);
			} else if (p.state === "error") {
				stopPolling();
				activeRequestId = null;
				textContent.textContent = `ã‚¨ãƒ©ãƒ¼: ${p.error_detail || p.message || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"}`;
				setBusy(false, "å¤±æ•—");
			} else if (p.state === "not_found") {
				stopPolling();
				activeRequestId = null;
				textContent.textContent = "ã‚¸ãƒ§ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆã‚µãƒ¼ãƒãƒ¼ãŒå†èµ·å‹•ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰";
				setBusy(false, "å¤±æ•—");
			}
		} catch(_) {}
	};
	poll();
	progressTimer = setInterval(poll, 500);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UI helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setBusy(busy, msg) {
	submitBtn.disabled = busy;
	const canCancel = busy && !!activeRequestId;
	cancelBtn.disabled = !canCancel;
	cancelBtn.classList.toggle("hidden", !canCancel);
	requestNote.textContent = msg;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Tabs
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll(".tab-btn").forEach(btn => {
	btn.addEventListener("click", () => {
		document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
		document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
		btn.classList.add("active");
		document.getElementById(`panel-${btn.dataset.tab}`).classList.add("active");
	});
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Lightbox
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escAttr(s) {
	return s.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function openImageLightbox(src) {
	lightboxContent.innerHTML = `<img src="${src}" alt="preview" />`;
	lightbox.classList.remove("hidden");
	document.body.style.overflow = "hidden";
}

function openHtmlLightbox(html) {
	lightboxContent.innerHTML = `<iframe srcdoc="${escAttr(html)}" sandbox="allow-same-origin"></iframe>`;
	lightbox.classList.remove("hidden");
	document.body.style.overflow = "hidden";
}

function closeLightbox() {
	lightbox.classList.add("hidden");
	lightboxContent.innerHTML = "";
	document.body.style.overflow = "";
}

lightboxClose.addEventListener("click", closeLightbox);
lightbox.addEventListener("click", e => { if (e.target === lightbox) closeLightbox(); });
document.addEventListener("keydown", e => { if (e.key === "Escape") closeLightbox(); });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Summary badges
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSummary(summary) {
	summaryRow.innerHTML = "";
	if (!summary || Object.keys(summary).length === 0) return;
	const labelMap = {
		text_block:"æœ¬æ–‡ãƒ–ãƒ­ãƒƒã‚¯", line_main:"æœ¬æ–‡", line_title:"è¦‹å‡ºã—",
		line_caption:"ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³", line_note:"å‰²æ³¨", line_note_tochu:"é ­æ³¨",
		block_fig:"å›³ç‰ˆ", block_table:"è¡¨", block_pillar:"æŸ±",
		block_folio:"ãƒãƒ³ãƒ–ãƒ«", block_chart:"å›³è¡¨", block_eqn:"æ•°å¼",
		block_ad:"åºƒå‘Š", block_rubi:"ãƒ«ãƒ“",
	};
	Object.entries(summary)
		.sort((a,b) => b[1]-a[1])
		.forEach(([k,v]) => {
			const span = document.createElement("span");
			span.className = "badge";
			span.textContent = `${labelMap[k]||k}: ${v}`;
			summaryRow.appendChild(span);
		});
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Page rendering
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPage(idx) {
	currentPageIndex = idx;
	const page = currentResults[idx];
	if (!page) return;

	textContent.textContent = page.text || "";

	htmlFrame.setAttribute("srcdoc", page.html ||
		"<p style='font-family:sans-serif;padding:1em;color:#888;'>HTML å‡ºåŠ›ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>");

	if (page.layout_preview_b64) {
		layoutImg.src = `data:image/jpeg;base64,${page.layout_preview_b64}`;
		layoutImg.classList.remove("hidden");
		layoutNone.classList.add("hidden");
	} else {
		layoutImg.classList.add("hidden");
		layoutNone.classList.remove("hidden");
	}

	renderSummary(page.summary);
	copyBtn.disabled = false;
}

function renderAllPages() {
	currentPageIndex = -1;
	textContent.textContent = currentResults.map(r => `[Page ${r.page}]\n${r.text || ""}`).join("\n\n") || "(çµæœãªã—)";
	htmlFrame.setAttribute("srcdoc", "<p style='font-family:sans-serif;padding:1em;color:#888;'>ãƒšãƒ¼ã‚¸ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>");
	layoutImg.classList.add("hidden");
	layoutNone.classList.remove("hidden");
	summaryRow.innerHTML = "";
	copyBtn.disabled = false;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HTML preview actions
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("htmlExpandBtn").addEventListener("click", () => {
	const page = currentPageIndex >= 0 ? currentResults[currentPageIndex] : null;
	if (page && page.html) openHtmlLightbox(page.html);
});

document.getElementById("htmlCopyBtn").addEventListener("click", async () => {
	const page = currentPageIndex >= 0 ? currentResults[currentPageIndex] : null;
	const text = (page && page.html) ? page.html : "";
	if (!text) return;
	const btn = document.getElementById("htmlCopyBtn");
	try { await navigator.clipboard.writeText(text); } catch(_) {}
	btn.textContent = "ã‚³ãƒ”ãƒ¼æ¸ˆã¿";
	setTimeout(() => { btn.textContent = "HTML ã‚³ãƒ”ãƒ¼"; }, 1200);
});

layoutImg.addEventListener("click", () => { if (layoutImg.src) openImageLightbox(layoutImg.src); });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Copy (ãƒ†ã‚­ã‚¹ãƒˆ tab)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
copyBtn.addEventListener("click", async () => {
	const text = textContent.textContent || "";
	try {
		await navigator.clipboard.writeText(text);
	} catch(_) {
		const ta = document.createElement("textarea");
		ta.value = text; ta.style.cssText = "position:fixed;opacity:0;";
		document.body.appendChild(ta); ta.select();
		try { document.execCommand("copy"); } finally { document.body.removeChild(ta); }
	}
	copyBtn.classList.add("copied");
	copyBtn.textContent = "ã‚³ãƒ”ãƒ¼æ¸ˆã¿";
	if (copyTimer) clearTimeout(copyTimer);
	copyTimer = setTimeout(() => {
		copyBtn.classList.remove("copied");
		copyBtn.textContent = "ã‚³ãƒ”ãƒ¼";
		copyTimer = null;
	}, 1200);
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Page selector
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pageSelect.addEventListener("change", () => {
	const v = pageSelect.value;
	if (v === "all") { renderAllPages(); return; }
	const idx = Number(v);
	if (!isNaN(idx)) renderPage(idx);
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Result rendering (called from polling on completion)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResults(payload, lbLabel) {
	currentResults = Array.isArray(payload.results) ? payload.results : [];

	document.getElementById("tagPages").textContent  = `pages: ${payload.page_count || 0}`;
	document.getElementById("tagDevice").textContent = `device: ${payload.device || "-"}`;

	if (currentResults.length === 0) {
		textContent.textContent = payload.state === "canceled" ? "ä¸­æ–­ã—ã¾ã—ãŸã€‚" : "çµæœãŒç©ºã§ã™ã€‚";
		setBusy(false, payload.state === "canceled" ? "ä¸­æ–­" : "å®Œäº†");
		return;
	}

	pageSelect.innerHTML = "";
	if (currentResults.length > 1) {
		const all = document.createElement("option");
		all.value = "all"; all.textContent = "ALL";
		pageSelect.appendChild(all);
		currentResults.forEach((r, i) => {
			const opt = document.createElement("option");
			opt.value = String(i); opt.textContent = `Page ${r.page}`;
			pageSelect.appendChild(opt);
		});
		pageSelect.value = "0";
		pagePickerWrap.classList.remove("hidden");
	}

	renderPage(0);
	setBusy(false, payload.state === "canceled" ? "ä¸­æ–­" : "å®Œäº†");
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Submit
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
form.addEventListener("submit", async e => {
	e.preventDefault();
	if (!fileInput.files || fileInput.files.length === 0) {
		alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
		return;
	}

	const fd = new FormData();
	fd.append("file",           fileInput.files[0]);
	fd.append("dpi",            document.getElementById("dpi").value);
	fd.append("linebreak_mode", document.getElementById("linebreak_mode").value);

	currentResults = [];
	currentPageIndex = 0;

	setBusy(true, "é€ä¿¡ä¸­...");
	resultPanel.classList.remove("hidden");
	pagePickerWrap.classList.add("hidden");
	summaryRow.innerHTML = "";
	textContent.textContent = "è§£æä¸­... ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚";
	htmlFrame.setAttribute("srcdoc", "");
	layoutImg.classList.add("hidden");
	layoutNone.classList.add("hidden");
	copyBtn.disabled = true;

	const lbEl = document.getElementById("linebreak_mode");
	const lbLabel = lbEl.options[lbEl.selectedIndex].text;
	document.getElementById("tagLinebreak").textContent = `æ”¹è¡Œ: ${lbLabel}`;
	document.getElementById("tagPages").textContent     = "pages: -";
	document.getElementById("tagDevice").textContent    = "device: -";

	try {
		const res = await fetch("/api/jobs", { method: "POST", body: fd });
		if (!res.ok) throw new Error("ã‚¸ãƒ§ãƒ–ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
		const { job_id } = await res.json();
		activeRequestId = job_id;
		startPolling(job_id);
	} catch(err) {
		textContent.textContent = `ã‚¨ãƒ©ãƒ¼: ${err.message}`;
		setBusy(false, "å¤±æ•—");
	}
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Cancel
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cancelBtn.addEventListener("click", async () => {
	if (!activeRequestId) return;
	cancelBtn.disabled = true;
	try {
		const res = await fetch(`/api/jobs/${encodeURIComponent(activeRequestId)}/cancel`, { method: "POST" });
		const p = await res.json();
		requestNote.textContent = p.message || "ä¸­æ–­è¦æ±‚ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ";
	} catch(err) {
		requestNote.textContent = `ä¸­æ–­å¤±æ•—: ${err.message}`;
		if (activeRequestId) cancelBtn.disabled = false;
	}
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Init
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fetchStatus();
		</script>
	</body>
</html>
