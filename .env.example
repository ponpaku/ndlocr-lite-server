# NDLOCR-Lite OCR Server 設定ファイル
# このファイルを .env にコピーして編集してください。
# cp .env.example .env

# --- サーバー ---
# 待受ホスト（外部公開する場合は 0.0.0.0）
NDLOCR_HOST=127.0.0.1

# 待受ポート
NDLOCR_PORT=7860

# --- デバイス ---
# auto : CUDA が使えれば cuda、使えなければ cpu を自動選択
# cuda : GPU 強制（CUDA 環境がない場合は起動時に cpu にフォールバック）
# cpu  : CPU 強制
NDLOCR_DEVICE=auto

# --- 並列処理 ---
# PDF の同時処理ページ数。
# この数だけ DEIM 検出器インスタンスが生成されるため、
# 増やすとメモリ（VRAM）消費が増える。
# CPU 使用率を下げたい場合は 1 に設定する。
NDLOCR_PAGE_WORKERS=2

# --- バッチ推論 ---
# PARSEQ 認識器のバッチ推論モード。
# auto  : device=cuda なら有効、cpu なら無効（推奨）
# true  : 常に有効（CUDA 環境でのみ効果あり）
# false : 常に無効（1行ずつ推論。CPU マルチスレッド動作時はこちらが速い場合がある）
NDLOCR_BATCH_INFERENCE=auto

# --- バッチサイズ上限 ---
# PARSEQ の 1 回の推論に渡す最大行数。
# PARSEQ は AR ループが ONNX グラフ内に完全展開されているため、
# バッチサイズが大きいほど中間テンソルが線形に増加し VRAM を圧迫する。
# これを超える行数は複数パスに分割して処理される。
# 小さくすると VRAM 消費が減る。大きくすると GPU 効率が上がるが VRAM が増える。
#   8  → 控えめ（VRAM 約 4GB 前後）
#  16  → 推奨（VRAM 約 5〜6GB 前後）
#  32  → 高速優先（VRAM 約 8GB 前後）
#   0  → 無制限（非推奨）
NDLOCR_MAX_BATCH=16

# --- VRAM 管理 ---
# リクエスト処理後のセッション解放モード。
# never  : 解放しない（デフォルト。warmup 済み環境で推奨）
# always : 毎リクエスト後に解放・再ロード（VRAM を他プロセスと共有する場合）
# auto   : NDLOCR_VRAM_LIMIT_GB を超えたときだけ解放・再ロード
NDLOCR_RELOAD=never

# NDLOCR_RELOAD=auto のときのリロード閾値 (GB)。
# リクエスト処理後の VRAM 使用量がこの値を超えていた場合にセッションを解放・再ロードする。
# 上限の保証ではなく「大きめのドキュメントを処理した後にプールをリセットする」目安として設定する。
# 例: GPU の VRAM が 12GB なら 9.0 程度に設定する。
# 0 は無効（auto でも解放しない）。
NDLOCR_RELOAD_THRESHOLD_GB=0
